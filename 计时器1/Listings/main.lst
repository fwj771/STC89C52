C51 COMPILER V9.54   MAIN                                                                  10/17/2025 14:19:00 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Keil\Keil5 C51\C51\BIN\C51.EXE main.c OMF2 OPTIMIZE(8,SPEED) BROWSE DEBUG PRINT(.\Listings\main.
                    -lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <REGX52.H>
   2          #include "LCD1602.h"
   3          #include "MatrixKey.h"
   4          #include "DelayMs.h"
   5          #include "KeyScan.h"
   6          #include "Timer.h"
   7          #include "Buzzer.h"
   8          
   9          // ---------------------- 全局变量 ----------------------
  10          unsigned char hour = 0;
  11          unsigned char minute = 0;
  12          unsigned char second = 0;
  13          
  14          sbit BUZZER = P2^5;     // 蜂鸣器控制引脚
  15          
  16          // 控制标志
  17          volatile bit updateDisplay = 0;
  18          bit isRunning = 0;
  19          bit settingMode = 0;
  20          unsigned char settingPos = 0; // 0~5 对应 时十、时个、分十、分个、秒十、秒个
  21          volatile bit alarmState = 0;
  22          
  23          // 闪烁相关
  24          volatile bit blinkState = 0;
  25          
  26          // 标志位（减少中断耗时）
  27          volatile bit flag_1s = 0;
  28          volatile bit flag_500ms = 0;
  29          
  30          // ---------------------- 函数定义 ----------------------
  31          void Display(void)
  32          {
  33   1        LCD_ShowString(1, 1, "Time:");
  34   1        LCD_ShowNum(1, 6, hour, 2);
  35   1        LCD_ShowString(1, 8, "H ");
  36   1        LCD_ShowNum(1, 10, minute, 2);
  37   1        LCD_ShowString(1, 12, "M ");
  38   1        LCD_ShowNum(1, 14, second, 2);
  39   1        LCD_ShowString(1, 16, "S");
  40   1      }
  41          
  42          // 设置输入
  43          void SettingInput(void)
  44          {
  45   1        unsigned char keyNum = MatrixKey_Scan();
  46   1      
  47   1        if(keyNum != 0xFF)
  48   1        {
  49   2          if(keyNum <= 9)
  50   2          {
  51   3            switch(settingPos)
  52   3            {
  53   4              case 0:
  54   4                hour = keyNum * 10 + (hour % 10);
C51 COMPILER V9.54   MAIN                                                                  10/17/2025 14:19:00 PAGE 2   

  55   4                break;
  56   4              case 1:
  57   4                hour = (hour / 10) * 10 + keyNum;
  58   4                break;
  59   4              case 2:
  60   4                minute = keyNum * 10 + (minute % 10);
  61   4                break;
  62   4              case 3:
  63   4                minute = (minute / 10) * 10 + keyNum;
  64   4                if(minute > 59) minute = 59;
  65   4                break;
  66   4              case 4:
  67   4                second = keyNum * 10 + (second % 10);
  68   4                break;
  69   4              case 5:
  70   4                second = (second / 10) * 10 + keyNum;
  71   4                if(second > 59) second = 59;
  72   4                blinkState = 0;    //防卡空格
  73   4                settingMode = 0;
  74   4                break;
  75   4            }
  76   3            if(settingPos < 5) settingPos++;
  77   3            updateDisplay = 1;
  78   3          }
  79   2        }
  80   1      }
  81          
  82          // 根据闪烁状态显示当前位
  83          void BlinkCurrentPos(void)
  84          {
  85   1        if(!blinkState)
  86   1        {
  87   2          // 处于亮显示状态
  88   2          Display();
  89   2        }
  90   1        else
  91   1        {
  92   2          // 闪烁隐藏当前位
  93   2          switch(settingPos)
  94   2          {
  95   3            case 0: LCD_ShowString(1, 6, " "); break;
  96   3            case 1: LCD_ShowString(1, 7, " "); break;
  97   3            case 2: LCD_ShowString(1, 10, " "); break;
  98   3            case 3: LCD_ShowString(1, 11, " "); break;
  99   3            case 4: LCD_ShowString(1, 14, " "); break;
 100   3            case 5: LCD_ShowString(1, 15, " "); break;
 101   3          }
 102   2        }
 103   1      }
 104          
 105          // 倒计时逻辑
 106          void CountDown(void)
 107          {
 108   1        if(second > 0)
 109   1          second--;
 110   1        else
 111   1        {
 112   2          if(minute > 0)
 113   2          {
 114   3            minute--;
 115   3            second = 59;
 116   3          }
C51 COMPILER V9.54   MAIN                                                                  10/17/2025 14:19:00 PAGE 3   

 117   2          else
 118   2          {
 119   3            if(hour > 0)
 120   3            {
 121   4              hour--;
 122   4              minute = 59;
 123   4              second = 59;
 124   4            }
 125   3            else
 126   3            {
 127   4              isRunning = 0; // 到达 00:00:00 停止
 128   4              alarmState = 1;
 129   4            }
 130   3          }
 131   2        }
 132   1        updateDisplay = 1;
 133   1      }
 134          
 135          // ---------------------- 主程序 ----------------------
 136          void main(void)
 137          {
 138   1        MatrixKey_Init();
 139   1        Timer0_Init();
 140   1        LCD_Init();
 141   1        Display();
 142   1        Buzzer_Init();
 143   1        while(1)
 144   1        {
 145   2          KeyScan();
 146   2      
 147   2          if(settingMode)
 148   2          {
 149   3            SettingInput();
 150   3            BlinkCurrentPos();
 151   3          }
 152   2          else if(updateDisplay)
 153   2          {
 154   3            Display();
 155   3          }
 156   2      
 157   2          updateDisplay = 0;
 158   2      
 159   2          // 每秒更新一次倒计时
 160   2          if(flag_1s)
 161   2          {
 162   3            flag_1s = 0;
 163   3            if(isRunning) CountDown();
 164   3          }
 165   2      
 166   2          // 500ms 闪烁控制
 167   2          if(flag_500ms)
 168   2          {
 169   3            flag_500ms = 0;
 170   3            blinkState = !blinkState;
 171   3          }
 172   2          
 173   2          if(alarmState)
 174   2          {
 175   3            MusicPlay();
 176   3          }
 177   2        }
 178   1      }
C51 COMPILER V9.54   MAIN                                                                  10/17/2025 14:19:00 PAGE 4   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    466    ----
   CONSTANT SIZE    =     16    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      4    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      7    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
